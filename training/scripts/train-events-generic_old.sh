#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# DO NOT MODIFY BELOW
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
#-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
source ./00_config-secrets.sh


echo "   __________  __ ___       _____    ________            "
echo "  / ____/ __ \/ // / |     / /   |  /  _/ __ \____  _____"
echo " / /   / /_/ / // /| | /| / / /| |  / // / / / __ \/ ___/"
echo "/ /___/ ____/__  __/ |/ |/ / ___ |_/ // /_/ / /_/ (__  ) "
echo "\____/_/      /_/  |__/|__/_/  |_/___/\____/ .___/____/  "
echo "                                          /_/            "
echo ""
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo " üöÄ  CP4WAIOPS Train Events for $APP_NAME"
echo ""
echo "***************************************************************************************************************************************************"



#--------------------------------------------------------------------------------------------------------------------------------------------
#  Check Defaults
#--------------------------------------------------------------------------------------------------------------------------------------------

if [[ $APP_NAME == "" ]] ;
then
      echo "‚ö†Ô∏è AppName not defined. Launching this script directly?"
      echo "‚ùå Aborting..."
      exit 1
fi


#--------------------------------------------------------------------------------------------------------------------------------------------
#  Get Credentials
#--------------------------------------------------------------------------------------------------------------------------------------------

echo "***************************************************************************************************************************************************"
echo "  üîê  Getting credentials"
echo "***************************************************************************************************************************************************"
oc project $WAIOPS_NAMESPACE >$log_output_path 2>&1  || true
export NOI_PASSWORD=$(oc get secrets -n $WAIOPS_NAMESPACE | grep omni-secret | awk '{print $1;}' | xargs oc get secret  -n $WAIOPS_NAMESPACE -o jsonpath --template '{.data.OMNIBUS_ROOT_PASSWORD}' | base64 --decode)

export WORKING_DIR_EVENTS="./training/TRAINING_FILES/GENERIC/$APP_NAME/events"


echo "      ‚úÖ OK"
echo ""
echo ""



#--------------------------------------------------------------------------------------------------------------------------------------------
#  Check Credentials
#--------------------------------------------------------------------------------------------------------------------------------------------

echo "***************************************************************************************************************************************************"
echo "  üîó  Checking credentials"
echo "***************************************************************************************************************************************************"


if [[ $NETCOOL_WEBHOOK_GENERIC == "not_configured" ]] || [[ $NETCOOL_WEBHOOK_GENERIC == "" ]];
then
      echo "‚ùå Event Manager Webhook not configured. Aborting..."
      exit 1
else
      echo "      ‚úÖ OK - Event Manager Webhook"
fi

if [[ $NOI_PASSWORD == "" ]] ;
then
      echo "‚ùå Cannot contact Event Manager"
      echo "‚ùå Make sure that Event Manager is running. Aborting..."
      exit 1
else
      echo "      ‚úÖ OK - Event Manager Password"
fi
echo ""
echo ""
echo ""
echo ""


echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo "  "
echo "  üîé  Parameter for Incident Simulation for $APP_NAME"
echo "  "
echo "           üîê Event Manager WebHook       : $NETCOOL_WEBHOOK_GENERIC"
echo "           üîê Event Manager Password      : $NOI_PASSWORD"
echo "  "
echo "           üìÇ Directory for Events        : $WORKING_DIR_EVENTS"
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo ""
echo "***************************************************************************************************************************************************"
echo "  üóÑÔ∏è  Files to be loaded for Events"
echo "***************************************************************************************************************************************************"
ls -1 $WORKING_DIR_EVENTS | grep "json"
echo "  "
echo "  "
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"

echo ""
echo ""


echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
  read -p " ‚ùó‚ùì Start Training? [y,N] " DO_COMM
  if [[ $DO_COMM == "y" ||  $DO_COMM == "Y" ]]; then
      echo "   ‚úÖ Ok, continuing..."
      echo ""
      echo ""
      echo ""
      echo ""

  else
    echo "‚ùå Aborted"
    exit 1
  fi
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo ""
echo ""
echo ""

echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo " üöÄ  Launching Event Training" 
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo ""
echo ""
echo ""


#--------------------------------------------------------------------------------------------------------------------------------------------
#  Start creating Events
#--------------------------------------------------------------------------------------------------------------------------------------------
echo "--------------------------------------------------------------------------------------------------------------------------------"
echo " üöÄ  Start training Event Manager Events for $APP_NAME" 
echo "      Quit with CTRL-C" 
echo "--------------------------------------------------------------------------------------------------------------------------------"

while true
do
      for actFile in $(ls -1 $WORKING_DIR_EVENTS | grep "json"); 
      do 

            #--------------------------------------------------------------------------------------------------------------------------------------------
            #  Deleting Event Manager Events
            #--------------------------------------------------------------------------------------------------------------------------------------------

            echo "--------------------------------------------------------------------------------------------------------------------------------"
            echo " üßª  Deleting Event Manager Events for $APP_NAME" 
            echo "--------------------------------------------------------------------------------------------------------------------------------"
oc get pods | grep ncoprimary-0 | awk '{print $1;}' | xargs -I{} oc exec {} -- bash -c "/opt/IBM/tivoli/netcool/omnibus/bin/nco_sql -server AGG_P -user root -passwd ${NOI_PASSWORD} << EOF
delete from alerts.status where AlertGroup='$APP_NAME';
go
exit
EOF"


            echo "--------------------------------------------------------------------------------------------------------------------------------"
            echo " üåè  Injecting Events from File: ${actFile}" 
            echo "--------------------------------------------------------------------------------------------------------------------------------"

            
            while IFS= read -r line
            do
                  export my_timestamp=$(date +%s)000

                  echo "Injecting Event at: $my_timestamp"
                  line=${line/MY_TIMESTAMP/$my_timestamp}

                  curl --insecure -X "POST" "$NETCOOL_WEBHOOK_GENERIC" \
                  -H 'Content-Type: application/json; charset=utf-8' \
                  -H 'Cookie: d291eb4934d76f7f45764b830cdb2d63=90c3dffd13019b5bae8fd5a840216896' \
                  -d $"${line}"
                  echo "      ‚úÖ OK"
            done < "$WORKING_DIR_EVENTS/$actFile"


      done
done
echo ""
echo ""
echo ""
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"
echo ""
echo " üöÄ  CP4WAIOPS Train Events for $APP_NAME"
echo " ‚úÖ  Done..... "
echo ""
echo "***************************************************************************************************************************************************"
echo "***************************************************************************************************************************************************"


