# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Install Script for Humio
#
# V3.1.1
#
# ¬©2021 nikh@ch.ibm.com
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

source ./tools/0_global/99_config-global.sh

# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# Do Not Edit Below
# ---------------------------------------------------------------------------------------------------------------------------------------------------"
# ---------------------------------------------------------------------------------------------------------------------------------------------------"

#headerModuleFileBegin "Install HUMIO " $0



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# PREREQUISITES
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Running Prerequisites" "rocket"

        export SCRIPT_PATH=$(pwd)
        __output "      ‚úÖ OK"

header3End



# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# Install Klusterlet
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
# ------------------------------------------------------------------------------------------------------------------------------------------------------------------------
header3Begin "Install HUMIO" "rocket"

        export HUMIO_INSTALLED=$(helm list -n humio-logging | grep deployed)


        if [[ $HUMIO_INSTALLED =~ "deployed" ]];
        then
                __output "    ‚≠ï HUMIO already installed! Skipping..."
        else
                helm repo add humio https://humio.github.io/humio-helm-charts
                helm repo update

                oc create ns humio-logging

                helm install humio-instance humio/humio-helm-charts \
                --namespace humio-logging \
                --values ./tools/4_integrations/humio/humio-install.yaml

                oc adm policy add-scc-to-user privileged -n humio-logging -z humio-instance
                oc adm policy add-scc-to-user privileged -n humio-logging -z default

                oc apply -n humio-logging -f ./tools/4_integrations/humio/humio-route.yaml

                __output "    üï¶ Wait 60 seconds..."

                oc delete -n humio-logging secret developer-user-password
                oc apply -n humio-logging -f ./tools/4_integrations/humio/change-humio-dev-pwd.yaml
                oc delete -n humio-logging pod humio-instance-humio-core-0

                __output " ‚úÖ HUMIO Installed"
                __output ""
                __output "  ‚ö†Ô∏è Please check the documentation in order to create the Fluentbit agents!"
                __output "    https://github.ibm.com/up-and-running/watson-aiops/blob/master/docs/automations/nik_installation_3.1/README_INSTALLATION.md#humio-fluentbit"
        fi


header3End





#headerModuleFileEnd "Install HUMIO " $0




